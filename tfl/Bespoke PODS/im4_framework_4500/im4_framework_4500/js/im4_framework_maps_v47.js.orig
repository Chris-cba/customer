/* -----------------------------------------------------------------------------
 --
 --   PVCS Identifiers :-
 --
 --       pvcsid           : $Header:   //vm_latest/archives/im/admin/im4_framework/js/im4_framework_maps_v47.js-arc   3.5   Oct 19 2011 09:29:44   Ian.Turnbull  $
 --       Module Name      : $Workfile:   im4_framework_maps_v47.js  $
 --       Date into PVCS   : $Date:   Oct 19 2011 09:29:44  $
 --       Date fetched Out : $Modtime:   Oct 19 2011 09:28:12  $
 --       PVCS Version     : $Revision:   3.5  $
 --       Based on SCCS version :
 --
 --
 -----------------------------------------------------------------------------
 --	Copyright (c) exor corporation ltd, 2009
 -----------------------------------------------------------------------------
 */
var mapview;var themebasedfoi;var SRID=null;var overviewContainer;var overviewMap;var legendContainer;var mapZoom=null;var featureZoom=5;var zoomType="C";var tagHtml;var mapUrl;var browserName=navigator.appName;var dataSource="-1";var baseURL=null;var imageURL=null;var baseMapString=null;var WMSMapString=null;var copyright=null;var baseMap=null;var WMSMap=null;var copyImage=null;var TmaTheFOI=null;var roadsFOI=null;var EnqTheFOI=null;var streetsTheme=null;function getMapVariables(){var a=new Array(100);for(var b=0;b<100;b++){a[b]=new Array(2)}var e=new htmldb_Get(null,html_GetElement("pFlowId").value,"APPLICATION_PROCESS=getMapVariables",0);gReturn=e.get("XML");if(gReturn){var d=gReturn.getElementsByTagName("PARAM_NAME").length;for(var c=0;c<d;c++){var h=gReturn.getElementsByTagName("PARAM_NAME")[c];var g=gReturn.getElementsByTagName("PARAM_VALUE")[c];a[c][0]=h.getAttribute("value");a[c][1]=g.getAttribute("value")}if(dataSource=="-1"){for(var f=0;f<d;f++){if(a[f][0]=="DATASOURCE"){dataSource=a[f][1]}if(a[f][0]=="IMAGEURL"){imageURL=a[f][1]}if(a[f][0]=="BASEURL"){baseURL=a[f][1]}if(a[f][0]=="BASEMAPSTR"){baseMapString=a[f][1]}if(a[f][0]=="WMSMAPSTR"){WMSMapString=a[f][1]}if(a[f][0]=="ROADSFOI"){roadsFOI=a[f][1]}if(a[f][0]=="ENQTHEFOI"){EnqTheFOI=a[f][1]}if(a[f][0]=="COPYRIGHT"){copyright=a[f][1]}if(a[f][0]=="STREETSTHE"){streetsTheme=a[f][1]}if(a[f][0]=="TMATHEFOI"){TmaTheFOI=a[f][1]}if(a[f][0]=="COPYIMG"){copyImage=a[f][1]}if(a[f][0]=="MAPSRID"){SRID=a[f][1]}if(a[f][0]=="INITZOOM"){mapZoom=a[f][1]}}}}e=null}function initMap(){var h=null;var f=null;var b=new htmldb_Get(null,html_GetElement("pFlowId").value,"APPLICATION_PROCESS=getmapcenterxy",0);var l=b.get("XML");b=null;if(l){var m=l.getElementsByTagName("X").length;for(var g=0;g<m;g++){var c=l.getElementsByTagName("X")[g];h=parseFloat(c.getAttribute("value"));var a=l.getElementsByTagName("Y")[g];f=parseFloat(a.getAttribute("value"))}}getMapVariables();var b=new htmldb_Get(null,html_GetElement("pFlowId").value,"APPLICATION_PROCESS=GET_USER_TEMP_VALUE",0);b.add("TEMP_TYPE","CURRENTZOOM");var j=b.get();var k=mapZoom;if(j){mapZoom=j}var d=MVSdoGeometry.createPoint(h,f,SRID);mapview=new MVMapView(document.getElementById("map"),baseURL);MVMapView.enableCodingHints(false);if(baseMapString!==null){baseMap=new MVBaseMap(dataSource+"."+baseMapString);mapview.addBaseMapLayer(baseMap)}if(WMSMapString!==null){WMSMap=new MVBaseMap(dataSource+"."+WMSMapString);mapview.addBaseMapLayer(WMSMap)}if(copyImage!==null){var e=new MVMapDecoration('<img class="mapCopyImage" src="'+copyImage+'" id="watermark"></img>',0,0,0,0,0,0);e.setPrintable(true);e.enableEventPropagation(true);mapview.addMapDecoration(e)}mapview.setCenter(d);mapview.setZoomLevel(mapZoom);mapview.addCopyRightNote(copyright);mapview.setHomeMap(d,k);mapview.addScaleBar();mapview.enableLoadingIcon(true);addInlineOverview();addLegend();mapview.addNavigationPanel("EAST");mapview.attachEventListener(MVEvent.ZOOM_LEVEL_CHANGE,getCurrentMapState);mapview.attachEventListener(MVEvent.RECENTER,getCurrentMapState);mapview.attachEventListener(MVEvent.INITIALIZE,getCurrentMapState);removeTemplated();addThemeBasedFOI()}function showMap(){initMap();mapview.display();mapview.getMapImageURL(getMapUrl)}function showMapNoDisplay(){initMap();setMapListener()}function setMapQueryType(a){document.getElementById("P0_MAP_QUERY_TYPE").value=a;setSessionValue("P0_MAP_QUERY_TYPE",a)}function executeLatestQuery(){var a=document.getElementById("P0_MAP_QUERY_TYPE").value;switch(a){case"FINDROADWORKS":showMapNoDisplay();setStreetTemplated();mapview.display();mapview.getMapImageURL(getMapUrl);setMapListener();break;case"FINDENQS":showMapNoDisplay();setEnqsTemplated("P0_ENQ_ID_INPUT");mapview.display();mapview.getMapImageURL(getMapUrl);setMapListener();break;case"FINDENQSREP":showMapNoDisplay();setEnqsTemplatedReport("P0_ENQ_ID");mapview.display();mapview.getMapImageURL(getMapUrl);setMapListener();break;case"FINDTMA":showMapNoDisplay();setRoadworksTemplated("P0_TMA_ID");mapview.display();mapview.getMapImageURL(getMapUrl);setMapListener();break;case"FINDNETWORK":showMapNoDisplay();setNetworkTemplated("P4_NE_UNIQUE");mapview.display();setMapListener();break;default:showMap();mapview.display();setMapListener()}setMapQueryType("")}function findEnqsFromReport(a,d,f){var g="P0_MAP_QUERY_TYPE,P0_ENQ_ID";var b="FINDENQSREP,"+a;var c="f?p="+d+":9:"+f+"::::"+g+":"+b;var e=window.open(c,"map","menubar=no,width=1024,height=768,toolbar=no,scrollbars=yes,resizable=yes,status=no");e.focus()}function findTMA(b,d,f,c){setMapQueryType("FINDTMA");document.getElementById("P0_TMA_ID").value=b;setSessionValue("P0_TMA_ID",b);var a="f?p="+d+":"+c+":"+f;var e=window.open(a,"map","menubar=no,width=1024,height=768,toolbar=no,scrollbars=yes,resizable=yes,status=no");e.focus()}function addThemeBasedFOI(){var h=null;var d=new htmldb_Get(null,html_GetElement("pFlowId").value,"APPLICATION_PROCESS=getFOIThemes",0);gReturn=d.get("XML");if(gReturn){var c=gReturn.getElementsByTagName("THEME_NAME").length;for(var f=0;f<c;f++){var b=gReturn.getElementsByTagName("THEME_NAME")[f];var g=gReturn.getElementsByTagName("ONOFF")[f].getAttribute("value");var e=gReturn.getElementsByTagName("MINVISIBLEZOOMLEVEL")[f].getAttribute("value");var a=gReturn.getElementsByTagName("MAXVISIBLEZOOMLEVEL")[f].getAttribute("value");var h=b.getAttribute("value");themebasedfoi=new MVThemeBasedFOI(h,dataSource+"."+h);themebasedfoi.setMinVisibleZoomLevel(e);themebasedfoi.setMaxVisibleZoomLevel(a);themebasedfoi.setBringToTopOnMouseOver(true);themebasedfoi.enableInfoTip(true);if(g==="ON"){themebasedfoi.setVisible(true)}else{themebasedfoi.setVisible(false)}if(h.substr(0,3)=="TMA"){themebasedfoi.setEventListener("mouse_click",foiTMAClick)}else{themebasedfoi.setEventListener("mouse_click",foiClick)}themebasedfoi.setInfoWindowStyle("MVInfoWindowStyle2");mapview.addThemeBasedFOI(themebasedfoi)}}d=null;mapview.getMapImageURL(getMapUrl)}function setVisibleFOI(b){var a=mapview.getThemeBasedFOI(b.value);if(a.isVisible()){a.setVisible(false)}else{a.setVisible(true)}}function addInlineOverview(){var e=$("#map").width();var b=$("#map").height();var c=e*0.1;var d=b*0.2;var a=(e*0.11)*-1;var f=(b*0.23)*-1;overviewContainer=new MVMapDecoration("<font face='Tahoma' size='4'>Overview Map</font>",null,null,c,d,a,f);overviewContainer.setCollapsible(true);overviewMap=new MVOverviewMap(overviewContainer.getContainerDiv(),2);overviewContainer.setDraggable(true);mapview.addOverviewMap(overviewMap);mapview.addMapDecoration(overviewContainer)}function addLegend(){var b=buildLegend(baseURL);var a=document.getElementById("mapLegendContainer");a.innerHTML=b}function buildLegend(c){var b=null;var a=new htmldb_Get(null,html_GetElement("pFlowId").value,"APPLICATION_PROCESS=getMapLegend",0);b=a.get();a=null;return b}function foiClick(b,c){var d=mapview.getAllFOIs();var a=250;var e=250;tagHtml=getMediaString(c);mapview.displayInfoWindow(b,tagHtml,a,e,"MVInfoWindowStyle2")}function foiTMAClick(b,c){var d=mapview.getAllFOIs();var a=450;var e=300;tagHtml=getMediaStringTMA(c);mapview.displayInfoWindow(b,tagHtml,a,e,"MVInfoWindowStyle2")}function openDocWindow(a){window.open(a)}function getMediaString(c){var d=c.attrs[0];var e=c.attrnames[0];var b;var a=new htmldb_Get(null,html_GetElement("pFlowId").value,"APPLICATION_PROCESS=getMapCallOut",0);a.add("DOC_ID",d);a.add("THEME_NAME",e);b=a.get();a=null;return b}function getMediaStringNetwork(c){var d=c.attrs[0];var b;var a=new htmldb_Get(null,html_GetElement("pFlowId").value,"APPLICATION_PROCESS=getMapItemNetDetails",0);a.add("DOC_ID",document.getElementById("P0_RSE_UNIQUE").value);b=a.get();a=null;return b}function getMediaStringTMA(c){var d=c.attrs[0];var b;var a=new htmldb_Get(null,html_GetElement("pFlowId").value,"APPLICATION_PROCESS=displayRoadworkDetails",0);a.add("ROAD_REF",d);b=a.get();a=null;return b}function getMediaStringINT(c){var d=c.attrs[0];var b;var a=new htmldb_Get(null,html_GetElement("pFlowId").value,"APPLICATION_PROCESS=getINTDetails",0);a.add("IIT_NE_ID",d);b=a.get();a=null;return b}function setMapListener(){}function mapPrint(){var b=document.getElementById("map");mapview.print(b)}function setStreetTemplated(){removeTemplated();var b=null;var d=document.getElementById("P0_TOWN").value.toUpperCase();var k=document.getElementById("P0_STREET").value.toUpperCase();var g=document.getElementById("P0_NSG").value.toUpperCase();var h=document.getElementById("P0_IMPACT_SEVERE_VALUE").value.toUpperCase();var e=document.getElementById("P0_IMPACT_MODERATE_VALUE").value.toUpperCase();var i=document.getElementById("P0_IMPACT_SLIGHT_VALUE").value.toUpperCase();var a=document.getElementById("P0_IMPACT_MINIMAL_VALUE").value.toUpperCase();var j=document.getElementById("P0_FROM_DATE_VALUE").value.toUpperCase();var f=document.getElementById("P0_TO_DATE_VALUE").value.toUpperCase();var c=new MVThemeBasedFOI("locator",dataSource+"."+streetsTheme);c.setQueryParameters(b,d,k,g,h,e,i,a,j,f);c.setBringToTopOnMouseOver(true);c.enableInfoTip(true);c.setVisible(true);c.setInfoWindowStyle("MVInfoWindowStyle1");c.setEventListener("mouse_click",foiClick);c.setBoundingTheme(true);mapview.addThemeBasedFOI(c)}function setEnqsTemplated(e){removeTemplated();var b=document.getElementById(e).value;var f=document.getElementById("P0_RESP_OF").value;var a=document.getElementById("P0_POSTCODE").value;var d=document.getElementById("P0_SURNAME").value;var c=new MVThemeBasedFOI("locator",dataSource+"."+EnqTheFOI);c.setQueryParameters(b,f,a,a,d,d);c.setBringToTopOnMouseOver(true);c.enableInfoTip(true);c.setVisible(true);c.setInfoWindowStyle("MVInfoWindowStyle1");c.setEventListener("mouse_click",foiClick);c.setBoundingTheme(true);mapview.addThemeBasedFOI(c)}function setEnqsTemplatedReport(e){removeTemplated();var b=document.getElementById(e).value;var f="";var a="";var d="";var c=new MVThemeBasedFOI("locator",dataSource+"."+EnqTheFOI);c.setQueryParameters(b,f,a,a,d,d);c.setBringToTopOnMouseOver(true);c.enableInfoTip(true);c.setVisible(true);c.setInfoWindowStyle("MVInfoWindowStyle1");c.setEventListener("mouse_click",foiClick);c.setBoundingTheme(true);mapview.addThemeBasedFOI(c)}function setRoadworksTemplated(c){var d="~";var e="~";var l="~";var h="~";var i="~";var f="~";var j="~";var a="~";var k="~";var g="~";removeTemplated();d=$("#"+c).val();if(!d){d="~"}else{i="true";f="true";j="true";a="true"}var b=new MVThemeBasedFOI("locator",dataSource+"."+TmaTheFOI);b.setQueryParameters(d,d,e,e,l,l,i,f,j,a,k,k,g,g,h,h);b.setBringToTopOnMouseOver(true);b.enableInfoTip(true);b.setVisible(true);b.setInfoWindowStyle("MVInfoWindowStyle1");b.setEventListener("mouse_click",foiTMAClick);b.setBoundingTheme(true);mapview.addThemeBasedFOI(b)}function setNetworkTemplated(f){removeTemplated();var e;var g=document.getElementById(f).value;var b=new htmldb_Get(null,html_GetElement("pFlowId").value,"APPLICATION_PROCESS=net_or_nsg",0);b.add("NETWORK_NAME",g);var h=b.get("XML");b=null;if(h){var j=h.getElementsByTagName("DATA").length;for(var d=0;d<j;d++){var a=h.getElementsByTagName("DATA")[d];e=a.getAttribute("value")}}var c=new MVThemeBasedFOI("locator",dataSource+"."+e);c.setQueryParameters(g,g);c.setBringToTopOnMouseOver(true);c.enableInfoTip(true);c.setVisible(true);c.setInfoWindowStyle("MVInfoWindowStyle1");c.setEventListener("mouse_click",foiClick);c.setBoundingTheme(true);mapview.addThemeBasedFOI(c)}function setTMASiteTemplated(b){removeTemplated();var a=document.getElementById(b).value;var c=new MVThemeBasedFOI("locator",tmaSitesThemeFOI);c.setQueryParameters(a);c.setBringToTopOnMouseOver(true);c.enableInfoTip(true);c.setVisible(true);c.setInfoWindowStyle("MVInfoWindowStyle1");c.setEventListener("mouse_click",foiClick);c.setBoundingTheme(true);mapview.addThemeBasedFOI(c)}function removeTemplated(){var a=mapview.getThemeBasedFOI("locator");mapview.removeThemeBasedFOI(a)}function togglebaseMap(a){if(a.checked){showbaseMap()}else{hidebaseMap()}}function showbaseMap(){baseMap.setVisible(true)}function hidebaseMap(){baseMap.setVisible(false)}function toggleWMS(a){if(a.checked){showWMS()}else{hideWMS()}}function showWMS(){WMSMap.setVisible(true)}function hideWMS(){WMSMap.setVisible(false)}function testjava(){alert("Your call worked")}function testjava(a){alert("Your call worked - myvar is");alert(a)}function getMapUrl(a){mapUrl=a}function callPrintMap(d,f){var b=$("#P0_MAP_TITLE_INPUT").val();var c=$("#P0_MAP_TEXT_INPUT").val();document.getElementById("P0_MAP_URL").value=mapUrl;setSessionValue("P0_MAP_URL",mapUrl);document.getElementById("P0_MAP_TITLE").value=b;setSessionValue("P0_MAP_TITLE",b);document.getElementById("P0_MAP_TEXT").value=c;setSessionValue("P0_MAP_TEXT",c);var a="f?p="+d+":0:"+f+":PRINT_REPORT=Print_Map";var e=window.open(a,"PrintMap","menubar=no,width=10,height=10,toolbar=no,scrollbars=no,resizable=no,status=no");e.focus()}function getCurrentMapState(d,a){var b=new htmldb_Get(null,html_GetElement("pFlowId").value,"APPLICATION_PROCESS=INS_USER_TEMP_VALUES",0);b.add("TEMPVALUE",mapview.getZoomLevel());b.add("TEMP_TYPE","CURRENTZOOM");var c=b.get();var e=mapview.getCenter();var b=new htmldb_Get(null,html_GetElement("pFlowId").value,"APPLICATION_PROCESS=INS_USER_TEMP_VALUES",0);b.add("TEMPVALUE",e.getPointX());b.add("TEMP_TYPE","POINTX");var c=b.get();var b=new htmldb_Get(null,html_GetElement("pFlowId").value,"APPLICATION_PROCESS=INS_USER_TEMP_VALUES",0);b.add("TEMPVALUE",e.getPointY());b.add("TEMP_TYPE","POINTY");var c=b.get();mapview.getMapImageURL(getMapUrl)}function showTemplatedTheme(b,a){removeTemplated();var c=new MVThemeBasedFOI("locator",dataSource+"."+b);c.setQueryParameters(a);c.setBringToTopOnMouseOver(true);c.enableInfoTip(true);c.setVisible(true);c.setInfoWindowStyle("MVInfoWindowStyle1");c.setEventListener("mouse_click",foiClick);c.setBoundingTheme(true);mapview.addThemeBasedFOI(c)};